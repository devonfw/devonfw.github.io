<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=">
<meta name="generator" content="Asciidoctor 1.5.8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- ******** SOCIAL MEDIA META ********** -->

<meta name="title" property="og:title" content="devonfw website">
<meta property="og:type" content="website">
<meta name="image" property="og:image" content="https://devonfw.com/images/devonfwwebsite.png">
<meta name="description" property="og:description" content="devonfw is the standard open source software development platform; Serving the full Software Delivery Life Cycle.">
<meta property="og:url" content="https://devonfw.com/index.html">

<meta name="twitter:title" content="devonfw website">
<meta name="twitter:description" content="devonfw is the standard open source software development platform; Serving the full Software Delivery Life Cycle.">
<meta name="twitter:image" content="https://devonfw.com/images/devonfwwebsite.png">
<meta name="twitter:card" content="summary_large_image">

<!-- ************************************* -->


<title>Start virtual server</title>
<!-- devonfw website stylesheet -->
<link rel="stylesheet" type="text/css" href="/devonfw.css">
<!-- Lunr -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/2.3.6/lunr.min.js" integrity="sha256-M/Awbb/BYh+Rh0aGjpQid26p1b2OBsrk2k9yAvQxPV0=" crossorigin="anonymous"></script>
<!-- JQuery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/7.4/styles/googlecode.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/7.4/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/7.4/lang/common.min.js"></script>
<script>hljs.initHighlightingOnLoad()</script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

<script src="https://cdn.jsdelivr.net/npm/anchor-js/anchor.min.js"></script>

<!-- ************** Google analytics ************ -->

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-151636804-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-151636804-1');
</script>

<!-- ******************************************** -->

</head>
<body id="Web-API-Test-Module-Smoke-Tests-virtualization.asciidoc" class="article">
<div id="website-navbar" class="website-navbar">
<button id="menu-button" class="menu-button">
  <img src="/images/menu-button.svg" width="32px" height="32px" alt=""/>
</button>

<ul>
<li>
<p><span class="image"><a class="image" href="/website/pages/welcome/welcome.html"><img alt="logo" src="/images/Logo_devonfw.svg"></a></span></p>
</li>
<li>
<p><a href="/website/pages/resources/resources.html">RESOURCES</a></p>
</li>
<li>
<p><a href="/website/pages/explore/explore.html">EXPLORE</a></p>
</li>
<li>
<p><a href="/website/pages/docs/master.html">DOCS</a></p>
</li>
<li>
<p><a href="/website/pages/community/community.html">COMMUNITY</a></p>
</li>
</ul>

<form class="form-inline">
  <div class="search-bar">
    <input
      id="search-field"
      type="search"
      class="form-control mr-sm-2"
      placeholder="Search by keyword(s)..."
      aria-label="Search"
      style="height: auto;"/>
    <div class="sb-res-pos px-4">
      <div id="click-outside" class="click-outside z-50 hidden"></div>
      <div class="col rounded px-0 border z-100 bg-white hidden search-bar-results" id="search-results-box">
      </div>
    </div>
  </div>
</form>
<a class="navbar-github text-white" href="https://github.com/devonfw/">
  <img src="/images/github-mark.png" width=auto height=auto alt="">
</a></div>
<div id="sidebar" class="wiki-sidebar"></div>

<div id="content" class="mt-4 mt-sm-5">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The following picture presents process of executing Smoke Tests in virtualized environment:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/home/runner/work/devonfw.github.io/devonfw.github.io/target/generated-docs/images/image78.png" alt="image78">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="web-api-test-module-smoke-tests-virtualization.asciidoc_install-docker-service">Install docker service</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If docker is not actually installed on machine (this should be checked during C2C creation) then install docker, docker-compose, apache2-utils, openssl (You can use <strong>script</strong> to install docker &amp; docker-compose OR refer to this <strong>post</strong> and add Alias for this machine &lt;C2C_Alias_Name&gt;):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>run the script</p>
</li>
<li>
<p>sudo apt-get install -y apache2-utils</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="web-api-test-module-smoke-tests-virtualization.asciidoc_build-docker-image">Build docker image</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Dockerfile:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>FROM docker.xxx.com/ubuntu:16.04
MAINTAINER Maintainer Name "maintainer@email.adress"
LABEL name=ubuntu_java \
           version=v1-8.0 \
           base="ubuntu:16.04" \
           build_date="03-22-2018" \
           java="1.8.0_162" \
           wiremock="2.14.0" \
           description="Docker to use with Ubuntu, JAVA and WIREMOCK "

# Update and install needed applications
COPY 80proxy /etc/apt/apt.conf.d/80proxy
RUN apt-get update
RUN apt-get install -y \
            wget \
            libfontconfig \
            unzip \
            zip
            ksh \
            curl \
            git

COPY wgetrc /etc/wgetrc

#Env parameters

### JAVA PART ###
#TO UPDATE:please verify url link to JDK http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html
##Download and install JAVA JDK8
RUN mkdir /opt/jdk
RUN wget -qq --header "Cookie: oraclelicense=accept-securebackup-cookie" http://download.oracle.com/otn-pub/java/jdk/8u162-b12/0da788060d494f509bf8624735fa2f1/jdk-8u162-linux-x64.tar.gz &amp;&amp; tar -zxf jdk-8u162-linux-x64.tar.gz -C /opt/jdk &amp;&amp; rm jdk-8u162-linux-x64.tar.gz &amp;&amp; update-alternatives --install /usr/bin/javac javac /opt/jdk/jdk1.8.0_162/bin/javac 100 &amp;&amp; java -version &amp;&amp; chmod 755 -R /opt/jdk/jdk1.8.0_162/
RUN java -version

##Add user
RUN useradd -u 29001 -g 100 srvpwiredev

##Add app
RUN mkdir -p -m 777 /app
COPY wiremock-standalone-2.14.0.jar /app/wiremock-standalone-2.14.0.jar

##Expose port
EXPOSE 8080

##Set workdir
WORKDIR /App

##Run app
CDM java -jar /app/wiremock-standalone-2.14.0.jar</pre>
</div>
</div>
<div class="paragraph">
<p>To build docker image and push it to repository execute following steps with specified version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>## Build image
sudo docker build -t docker.xxx.com/app/build/wiremock:v2.14.0.

## Push image
sudo docker login docker.xxx.com
sudo docker push docker.xxx.com/app/build/wiremock:v2.14.0.</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="web-api-test-module-smoke-tests-virtualization.asciidoc_run-docker-image">Run docker image</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To run docker image execute following command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>sudo docker run -td -p 8080:8080 -v /home/wiremock/repo/app/docker/QA/mappings:/app/mappings -v /home/wiremock/repo/app/docker/QA/__files:/app/__files --restart always docker.xxx.com/app/build/wiremock:v2.14.0.</pre>
</div>
</div>
<div class="paragraph">
<p>Where:</p>
</div>
<div class="paragraph">
<p><strong>-p</strong> - publish a container’s port to the host</p>
</div>
<div class="paragraph">
<p><strong>-v</strong> - bind mount a volume. WireMock server creates two directories under the current one: mappings and __files. It is needed to mount directories with already created mappings and responses to make it working.</p>
</div>
<div class="paragraph">
<p><strong>-restart always</strong> - restart policy to apply when a container exists</p>
</div>
<div class="paragraph">
<p>All of run parameters are described in: <a href="https://docs.docker.com/engine/reference/run/">official docker documentation</a></p>
</div>
</div>
</div>
<h1 id="Web-API-Test-Module-Smoke-Tests-virtualization.asciidoc" class="sect0">Map requests with virtual assets</h1>
<div class="paragraph">
<p><strong>What is WireMock?</strong></p>
</div>
<div class="paragraph">
<p>WireMock is an HTTP mock server. At its core it is web server that can be primed to serve canned responses to particular requests (stubing) and that captures incoming requests so that they can be checked later (verification). It also has an assortment of other useful features including record/playback of interactions with other APIs, injection of faults and delays, simulation of stateful behaviour.</p>
</div>
<div class="paragraph">
<p>Full documentation can be found under following link: <a href="http://wiremock.org/docs">WireMock</a></p>
</div>
<div class="sect1">
<h2 id="web-api-test-module-smoke-tests-virtualization.asciidoc_record--create-virtual-assets-mappings">Record / create virtual assets mappings</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Record</strong></p>
</div>
<div class="paragraph">
<p>WireMock can create stub mappings from requests it has received. Combined with its proxying feature this allows you to "record" stub mappings from interaction with existing APIs.</p>
</div>
<div class="paragraph">
<p>Record and playback (Legacy): <a href="http://wiremock.org/docs/record-playback-legacy/">documentation</a></p>
</div>
<div class="literalblock">
<div class="content">
<pre>java -jar wiremock-standalone-2.16.0.jar --proxy-all="http://search.twitter.com" --record-mappings --verbose</pre>
</div>
</div>
<div class="paragraph">
<p>Once it’s started and request is sent to it then it will be redirected to "http://search.twitter.com" and traffic (response) is saved to files in mappings and __files directories for futher use.</p>
</div>
<div class="paragraph">
<p>Record and playback (New): <a href="http://wiremock.org/docs/record-playback/">documentation</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="web-api-test-module-smoke-tests-virtualization.asciidoc_enable-mappings-in-virtual-server">Enable mappings in virtual server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When the WireMock server starts it creates two directories uder the current one: mappings and __files. To create a stub it is needed to drop a file with a .son extension under mappings.</p>
</div>
<div class="paragraph">
<p><strong>Run docker with mounted volumes</strong></p>
</div>
<div class="paragraph">
<p>Mappings are in repository. It is needed to mount directories with already created mappings and responses to make it working:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>sudo docker run -td -p 8080:8080 -v /home/wiremock/repo/app/docker/QA/mappings:/app/mappings -v /home/wiremock/repo/app/docker/QA/__files:/app/__files --restart always docker.xxx.com/app/build/wiremock:v2.14.0.</pre>
</div>
</div>
<div class="paragraph">
<p>Description of how to build and run docker is available in: <a href="https://docs.docker.com/engine/reference/run/">Docker run command description</a></p>
</div>
<div class="paragraph">
<p><strong>Recorded mappings</strong></p>
</div>
<div class="paragraph">
<p>Rrecorded mappings are in the project repository.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="web-api-test-module-smoke-tests-virtualization.asciidoc_create-user-and-map-him-to-docker-user">Create user and map him to docker user</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To Enable connection from Jenkins to Virtual Server (C2C) it is needed to create user and map him to docker group user. It can be done using following command:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>adduser -G docker -m wiremock</pre>
</div>
</div>
<div class="paragraph">
<p>To set the password for wiremock user:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>passwd wiremock</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="web-api-test-module-smoke-tests-virtualization.asciidoc_create-ssh-private-and-public-keys-for-wiremock-user">Create SSH private and public keys for wiremock user</h2>
<div class="sectionbody">
<div class="paragraph">
<p>SSH keys serve as a means of identifying yourself to an SSH server using <a href="https://en.wikipedia.org/wiki/Public-key_cryptography">public-key cryptography</a> and <a href="https://en.wikipedia.org/wiki/Challenge%E2%80%93response_authentication">challenge-response authentication</a>. One Immediate advantage this method has over traditional password is that you can be authenticated by the server without ever having to send your password over the network.</p>
</div>
<div class="paragraph">
<p>To create SSH key, log in as wiremock (previously created user).</p>
</div>
<div class="literalblock">
<div class="content">
<pre>su wiremock</pre>
</div>
</div>
<div class="paragraph">
<p>The .ssh directory is not by default created below user home directody. So, it is needed to create it:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>mkdir ~/.ssh</pre>
</div>
</div>
<div class="paragraph">
<p>Now we can proceed with creating RSA key using ssh-keygen (tool for creating new authentication key pairs for SSH):</p>
</div>
<div class="literalblock">
<div class="content">
<pre>ssh-keygen -t rsa</pre>
</div>
</div>
<div class="paragraph">
<p>Key should be created under /.ssh/id_rsa Appending the public keys to authorized_keys:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>wiremock@vc2crptXXXXXXXn:~/ssh$ cat id_rsa.pub &gt;&gt; authorized_keys</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="web-api-test-module-smoke-tests-virtualization.asciidoc_install-ssh-key-in-jenkins">Install SSH key in Jenkins</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To add ssh key to Jenkins go to credentials in location with your job. Choose Folder within credentials. Then 'global credentials'. And 'Add credentials'. Fill the fields. And finally entry should be created.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="web-api-test-module-smoke-tests-virtualization.asciidoc_build-jenkins-groovy-script">Build Jenkins Groovy script</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Description of how to use SSH Agent plugin in Jenkins pipeline can be found under: <a href="https://www.karthikeyan.tech/2017/09/ssh-agent-blue-ocean-via-jenkins.html" class="bare">https://www.karthikeyan.tech/2017/09/ssh-agent-blue-ocean-via-jenkins.html</a></p>
</div>
<div class="paragraph">
<p>Example of use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>sshagent (credentials: [env.WIREMOCK_CREDENTIALS]) {
     sh """
         ssh -T -o StrictHostKeyChecking=no -l ${env.WIREMOCK_USERNAME} ${env.WIREMOCK_IP_ADRESS} "docker container restart ${env.WIREMOCK_CONTAINER_NAME}"
     """
}</pre>
</div>
</div>
<div class="paragraph">
<p>Where: env.WIREMOCK_CREDENTIALS is a credential id of previously created wiremock credentials. Now as it is presented we can execute commands on remote machine, where in ssh command: env.WIREMOCK_USERNAME - user name of user connected with configured private key env.WIREMOCK_IP_ADRESS - ip address of machine where this user with this private key exists</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="web-api-test-module-smoke-tests-virtualization.asciidoc_pull-repository-with-virtual-assets">Pull repository with virtual assets</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To pull the repository on remote kacine it is needed to use previously described SSH Agent plugin Example of use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>sshagent (credentials: [env.WIREMOCK_CREDENTIALS]) {
withCredentials([usernamePassword(credentialsId: end.STASH_CREDENTIALS, passwordVariable: 'PASS', usernameVariable: 'USER')]) {
     sh """
         ssh -T -o StrictHostKeyChecking=no -l ${env.WIREMOCK_USERNAME} ${env.WIREMOCK_IP_ADRESS} "cd ~/${env.APPLICATION_DIRECTORY_WIREMOCK}/${env.PROJET_HOME}; git fetch https://&amp;USER:$PASS@${env.GIT_WITHOUT_HTTPS} ${env.GIT_BRANCH}; git reset --hard FETCH_HEAD; git clean -df"
      """
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p>Where:</p>
</div>
<div class="paragraph">
<p><strong>withCredentials</strong> allows various kinds of credentials (secrets) to be used in idiosyncratic ways. Each binding will define an environment variable active within the scope of the step. Then needed commands are executed:</p>
</div>
<div class="paragraph">
<p><code>cd …​</code> - command will change from current directory to specified directory with git repository</p>
</div>
<div class="paragraph">
<p><code>git fetch …​ ;git reset …​ ;git clean …​</code> - pull from GIT branch. Git pull or checkout are not used here to prevent situation with wrong coding between Mac OSX/Linux etc.</p>
</div>
<div class="paragraph">
<p><strong>PLEASE remember that when using this script for the first time code from previous block should be turned to:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>stage("ssh-agent"){
        sshagent (credentials: [env.WIREMOCK_CREDENTIALS]) {
            withCredentials([usernamePassword(credentialsId: end.STASH_CREDENTIALS, passwordVariable: 'PASS', usernameVariable: 'USER')]) {
                sh """
                        ssh -T -o StrictHostKeyChecking=no -l ${env.WIREMOCK_USERNAME} ${env.WIREMOCK_IP_ADRESS} "cd ~/${env.APPLICATION_DIRECTORY_WIREMOCK} ;git clone --depth=1 --branch=develop https://&amp;USER:$PASS@${env.GIT_WITHOUT_HTTPS}"';
                """
    }
}</pre>
</div>
</div>
</div>
</div>
<h1 id="Web-API-Test-Module-Smoke-Tests-virtualization.asciidoc" class="sect0">Install application with Smoke environment</h1>
<div class="sect1">
<h2 id="web-api-test-module-smoke-tests-virtualization.asciidoc_update-properties-settings-file">Update properties settings file</h2>
<div class="sectionbody">
<div class="paragraph">
<p>New settings file is pushed to the repository. Example configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>...
   &lt;key&gt;autocomplete&lt;/key&gt;
   &lt;string&gt;http://server:port&lt;/string&gt;
   &lt;key&gt;benefitsummary&lt;/key&gt;
   &lt;string&gt;http://server:port&lt;/string&gt;
   &lt;key&gt;checkscan&lt;/key&gt;
   &lt;string&gt;http://server:port&lt;/string&gt;
   &lt;key&gt;dpesb&lt;/key&gt;
   &lt;string&gt;http://server:port&lt;/string&gt;
...</pre>
</div>
</div>
<div class="paragraph">
<p>Adress of service (backend) should be changed to wiremock addres as it is shown on listing to change the default route.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="web-api-test-module-smoke-tests-virtualization.asciidoc_build-application-with-updated-properties-file">Build application with updated properties file</h2>
<div class="sectionbody">
<div class="paragraph">
<p>New version of application are prepared by Jenkins job.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="web-api-test-module-smoke-tests-virtualization.asciidoc_install-application-on-target-properties-file">Install application on target properties file</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Installation of application is actually executed in non-automated way using SeeTest environment.</p>
</div>
</div>
</div>
<h1 id="Web-API-Test-Module-Smoke-Tests-virtualization.asciidoc" class="sect0">UI tests</h1>
<div class="sect1">
<h2 id="web-api-test-module-smoke-tests-virtualization.asciidoc_run-jenkins-job">Run Jenkins job</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Jenkinsfile:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>// Jenkins parameters are overriding below properties
def properties = [

          JENKINS_LABELS                                 : 'PWI_LINUX_DEV',
          APPLICATION_FOLDER                             : 'app_dir',
          PROJECT_HOME                                   : 'app_home_folder',

          //WIREMOCK
          WIREMOCK_CREDENTIALS                           : 'vc2crptXXXXXXn',
          WIREMOCK_USERNAME                              : 'wiremock',
          WIREMOCK_ADDRESS                               : 'http://vc2crptXXXXXXn.xxx.com:8080',
          WIREMOCK_IP_ADRESS                             : '10.196.67.XXX',
          WIREMOCK_CONTAINER_NAME                        : 'wiremock',
          APPLICATION_DIRECTORY_WIREMOCK                 : 'repo',

          //GIT
          GIT_CREDENTIALS                                : 'e47742cc-bb66-4321-2341-a2342er24f2',
          GIT_BRANCH                                     : 'develop',
          GIT_SSH                                        : 'ssh://git@stash.xxx.com/app/app.git'
          GIT_HTTPS                                      : 'HTTPS://git@stash.xxx.com/app/app.git',

          STASH_CREDENTIALS                              : 'e47742cc-bb66-4321-2341-a2342er24f2',


          //DOCKER
          ARTIFACTORY_USER_CREDENTIALS                   : 'e47742cc-bb66-4321-2341-a2342er24f2',
          SEETEST_DOCKER_IMAGE                           : 'docker.xxx.com/project/images/app:v1-8.3',

          //SEETEST_DOCKER_IMAGE
          SEETEST_APPLICATION_FOLDER                     : 'seetest_dir',
          SEETEST_PROJECT_HOME                           : 'Automated Scripts',
          SEETEST_GIT_SSH                                : 'ssh://git@stash.xxx.com/pr/seetest_automation_cucumber.git'
          SEETEST_GIT_BRANCH                             : 'develop',
          SEETEST_GRID_USER_CREDENTIALS                  : 'e47742cc-bb66-4321-2341-a2342er24f2',
          SEETEST_CUCUMBER_TAG                           : '@Virtualization',
          SEETEST_CLOUD_NAME                             : 'Core Group',
          SEETEST_IOS_VERSION                            : '11',
          SEETEST_IOS_APP_URL                            : '',
          SEETEST_INSTALL_APP                            : 'No',
          SEETEST_APP_ENVIRONMENT                        : 'SmokeTests',
          SEETEST_DEVICE_QUERY                           : '',
]

node(properties.JENKINS_LABELS) {
    try {
        prepareEnv(properties)
        gitCheckout()
        stageStartVirtualServer()
        stageMapApiRequests()
        stageInstallApplication()
        stageUITests()
     } catch(Exception ex) {
        currentBuild.result = 'FAILURE'
        error = 'Error' + ex
     }
}

//====================================END OF PIPELINE==========================================

private void prepareEnv(properties) {
    cleanWorkspace()
    overrideProperties(properties)
    setWorkspace()
}

private void gitCheckout() {
    dir(env.APPLICATION_FOLDER) {
        checkout([$class: 'GitSCM', branches: [[Web-API-Test-Module-Smoke-Tests-virtualization.asciidoc_name: env.GIT_BRANCH]], doGenerateSubmoduleConfiguration: false, extensions: [[Web-API-Test-Module-Smoke-Tests-virtualization.asciidoc_$class: 'CloneOption', depth: 0, noTags: false, reference: '', shallow: false, timeout: 50]], gitTool: 'Default', submoduleCfg: [], userRemoteConfigs: [[Web-API-Test-Module-Smoke-Tests-virtualization.asciidoc_credentialsId: env.GIT_CREDENTIALS, url: env.GIT_SSH]])
     }
}

private void stageStartVirtualServer() {
    def module = load "${env.SUBMODULES_DIR}/stageStartVirtualServer.groovy"
    module()
}

private void stageMapApiRequests() {
    def module = load "${env.SUBMODULES_DIR}/stageMapApiRequests.groovy"
    module()
}

private void stageInstallApplication() {
    def module = load "${env.SUBMODULES_DIR}/stageInstallApplication.groovy"
    module()
}

private void stageUITests() {
    def module = load "${env.SUBMODULES_DIR}/stageUITests.groovy"
    module()
}

private void setWorkspace() {
    String workspace = pwd()
    env.APPLICATION_DIRECTORY = "/${env.APPLICATION_DIRECTORY}"
    env.WORKSPACE_LOCAL - workspace + env.APPLICATION_DIRECTORY
    env.SEETEST_PROJECT_HOME_ABSOLute_PATH = "${workspace}/${env.SEETEST_APPLICATION_FOLDER}/${env.SEETEST_PROJECT_HOME}"
    env.SUBMODULES_DIR = env.WORKSPACE_LOCAL + "/pipelines/SmokeTests.submodules"
    env.COMMONS_DIR    = env.WORKSPACE_LOCAL + "/pipelines/commons"
}

/*
    function ovverrides env vales based on provided properties
*/
private void overrideProperties(properties) {
    for (param in properties) {
        if (env.(param.key) == null) {
           echo "Adding parameter '${param.key}' with default value: '$param.value}'"
           env.(param.key) = param.value
        } else {
           echo "Parameter '${param.key}' has overriden value: '${env.(param.key)}'"
        }
     }

     echo sh(script: "env | sort", returnStdout: true)
}

private void cleanWorkspace() {
   sh 'rm-rf *'
}</pre>
</div>
</div>
<div class="paragraph">
<p>stageStartVirtualServer.groovy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>def call () {
    stage("Check virtual server") {
        def statusCode

        try {
            def response = httpRequest "${env.WIREMOCK_ADDRESS}/__admin/"
            statusCode = response.status
        } catch(Exception ex) {
            currentBuild.result = 'FAILURE'
            error 'WireMock server os unreachable.'
        }

        if(statusCode !=200) {
            currentBuild.result = 'FAILURE'
            error 'WireMock server is unreachable. Return code: ${statusCode}'
        }
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p>stageMapApiRequests.groovy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>def call() {
    stage("Map API requests with virtual assets") {
        checkoutRepository()
        restartWiremock()
        checkWiremockStatus()
     }
}

private checkoutRepository() {
    extractHTTPSUrl()
    sshagent (credentials: [env.WIREMOCK_CREDENTIALS]) {
        withCredentials([usernamePassword(credentialsId: env.STASH_CREDENTIALS, passwordVariable: 'PASS', usernameVariable: 'USER')]) {
            sh """
                ssh -T -o StrictHostKeyChecking=no -l ${env.WIREMOCK_USERNAME} ${env.WIREMOCK_IP_ADDRESS} "cd~/${env.APPLICATION_DIRECTORY_WIREMOCK}/${env.PROJECT_HOME}; git fetch https://$USER:$PASS@${env.GIT_WITHOUT_HTTPS} ${env.GIT_BRANCH}; git reset --hard FETCH_HEAD; git clean -df"
             """
         }
     }
}

private restartWiremock() {
    sshagent (credentials: [env.WIREMOCK_CREDENTIALS]) {
            sh """
                ssh -T -o StrictHostKeyChecking=no -l ${env.WIREMOCK_USERNAME} ${env.WIREMOCK_IP_ADDRESS} "docker container restart ${env.WIREMOCK_CONTAINER_NAME}"
             """
     }
}

private checkWiremockStatus() {
    int wiremockStatusCheckCounter =6
    int sleepTimeInSeconds = 10
    def wiremockStatus

    for (i = 0; i &lt; wiremockStatusCheckCounter; i++) {
         try {
             wiremockStatus = getHttpRequestStatus()
             echo "WireMock server status code: ${wiremockStatus}"
         } catch(Exceprion ex) {
             echo "Exception when checking connection to WireMock"
         }
         if(wiremockStatus == 200) break
         else sh "sleep $(sleepTimeInSeconds}"
      }

      if(wiremockStatus != 200) {
          currentBuild.result = 'FAILURE'
          error 'WireMock server is unreachable. Return code: ${wiremockStatus}'
      }
}

private def getHttpRequestStatus() {
    def response = httpRequest "${env.WIREMOCK_ADDRESS}/__admin"
    return response.status

private extractHTTPSUrl() {
    env.GIT_WITHOUT_HTTPS = env.GIT_HTTPS.replace("https://", "")
}

return this</pre>
</div>
</div>
<div class="paragraph">
<p>stageInstallApplication.groovy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>def call() {
    stage('Install application with smoke tests environment') {
        dir(env.SEETEST_APPLICATION_FOLDER) {
            checkout([$class: 'GitSCM', branches: [[Web-API-Test-Module-Smoke-Tests-virtualization.asciidoc_name: env.SEETEST_GIT_BRANCH]], doGenerateSubmoduleConfigurations: false, extensions: [], gitTool: 'default', submoduleCfg: [], userRemoteConfigs: [[Web-API-Test-Module-Smoke-Tests-virtualization.asciidoc_credentialsId: env.GIT_CREDENTIALS, url: env.SEETEST_GIT_SSH]])
        }
     }
}

return this</pre>
</div>
</div>
<div class="paragraph">
<p>stageUITests.groovy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>def call() {
    stage('UI tests') {
        def utils = load "${env.SUBMODULES_DIR}/utils.groovy"

        try {
            utils.generateUserIDVariable(); //Generate USER_ID and USER_GROUP
            docker.image(env.SEETEST_DOCKER_IMAGE).inside("-u ${env.USER_ID}:${env.USER_GROUP}") {
                withCredentials([[Web-API-Test-Module-Smoke-Tests-virtualization.asciidoc_$class: 'UsernamePasswordMultiBinding', credentialsId: "${env.ARTIFACTORY_USER_CREDENTIALS}", passwordVariable: 'ARTIFACTORY_PASSWORD', usernameVariable: 'ARTIFACTORY_USERNAME]]) {
                    executeTests()
                    compressArtifacts()
                    publishJUnitTestResultReport()
                    archiveArtifacts()
                    publishHTMLReports()
                    publishCucumberReports()
                 }
             }
        } catch (Exception exc) {
            throw exc
        }
   }
}

private executeTests() {
    withCredentials([usernamePassword(credentialsId: env.SEETEST_GRID_USER_CREDENTIALS, passwordVariable: 'GRID_USER_PASSWORD', usernameVariable: 'GRID_USER_NAME')]) {
            sh """
                cd ${env.SEETEST_PROJECT_HOME_ABSOLUTE_PATH}
                mvn clean test -B -Ddriver="grid" -Dtags="${env.SEETEST_CUCUMBER_TAG}" -DcloudName="${env.SEETEST_CLOUD_NAME}" -DdeviceQuery="${env.SEETEST_DEVICE_QUERY} -DgridUser="${GRID_USER_NAME}" -DgridPassword="${GRID_USER_PASSWORD}" -Dinstall="${env.SEETEST_INSTALL_APP}" -DiosUrl="${env.SEETEST_IOS_APP_URL}" -DdeviceType="iPhone" -DiosVersion="$env.SEETEST_IOS_VERSION}" -DparallelMode="allonall" -Denv="${env.SEETEST_APP_ENVIRONMENT}" site
             """
     }
}

private compressartifacts() {
    echo "Compressing artifacts from /target/site"
    sh """
        zip -r allure_report.zip **/${env.SEETEST_PROJECT_homE}/target/site
    """

private publishJUnitTestResultReport() {
    echo "Publishing JUnit reports from ${env.SEETEST_APPLICATION_FOLDER}/${env.SEETEST_PROJECT_HOME}/target/surefire-reports/junitreporters/*.xml"

    try {
        junit "${env.SEETEST_APPLICATION_FOLDER}/${env.SEETEST_PROJECT_HOME}/target/surefire-reports/junitreporters/*.xml"
    } catch(e) {
        echo("No JUnit report found")
    }
}

private archiveArtifacts() {
    echo "Archiving artifacts"

    try {
        archiveArtifacts allowEmptyArchive: true, artifacts: "**/allure_report.zip"
    } catch(e) {
        echo("No artifacts found")
    }
}

private publishHTMLReports() {
    echo "Publishing HTML reports from ${env.SEETEST_APPLICATION_FOLDER}/${env.SEETEST_PROJECT_HOME}/target/site/allure-maven-plugin"

    try {
        publishHTML([allowMissing: false, alwaysLinkToLastBuild: true, keepAll: true, reportDir: "${env.SEETEST_APPLICATION_FOLDER/${env.SEETEST_PROJECT_HOME}/target/site/allure-maven-plugin", reportFiles: 'index.html', reportName: 'Allure report', reportTitles: 'Allure report'])
    } catch(e) {
        echo("No artifacts found")
    }
}

private publishCucumberREPORTS() {
    echo "Publishing Cucumber reports from ${env.SEETEST_APPLICATION_FOLDER}/${env.SEETEST_PROJECT_HOME}/target/cucumber-parallel/*.json"

    try {
        step([$class: 'CucumberReportPublisher', fileExcludePattern '', fileIncludePattern: "#{env.SEETEST_APPLICATION_FOLDER}/${env.SEETEST_PROJECT_HOME}/target/cucumber-parallel/*.json", ignoreFailedTests: false, jenkinsBasePath: '', jsonReportDirectory: '', missingFails: false, parallelTesting: false, pendingFails: false, skippedFails: false, undefinedFails: false])
    } catch(e) {
        echo("No Cucumber report found")
    }
}

return this</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Configuration</strong></p>
</div>
<div class="paragraph">
<p>It is possible to configure Jenkins job in two ways. First one is to edit Jenkinsfile. All of the properties are in properties collection as below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>def properties = [

          JENKINS_LABELS                                : 'PWI_LINUX_DEV'

          ...

          //Docker
          ARTIFACTORY_USER_CREDENTIALS                  : 'ba2e4f46-56f1-4467-ae97-17b356d6s643',
          SEETEST_DOCKER_IMAGE                          : 'docker.XXX.com/app/base-images/seetest:v1-8.3',

          //SeeTest
          SEETEST_APPLICATION_FOLDER                    : 'seetest_dit',
          SEETEST_PROJECT_HOME                          : 'Automated_Scripts',
          SEETEST_GIT_SSH                               : 'ssh://stash.xxx.com/app/seetest_automation_cucumber.git',
          SEETEST_GIT_BRANCH                            : 'develop',

          ...
]</pre>
</div>
</div>
<div class="paragraph">
<p>Second one is to add properties in 'Configure job'. All of there properties are overriding properties from Jenkinsfile (have biggest priority). Then it can be set durring 'Build with Paremeters' process.</p>
</div>
<div class="paragraph">
<p><strong>Reports</strong></p>
</div>
<div class="paragraph">
<p>After job execution 'Allure report' and 'Cucumber-JVM' reports should be visible. If any tests fails You can check on which screen (printscreen from failures is attached, why and etc.)</p>
</div>
</div>
</div>
</div>
<div id="footer" class="footer">
<div class="openblock footerLinks">
<div class="content">
<div class="dlist linklist">
<dl>
<dt class="hdlist1">About</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="/website/pages/docs/getting-started.asciidoc_introduction.html">About devonfw</a></p>
</li>
<li>
<p><a href="/website/pages/docs/getting-started.asciidoc_introduction.html#introduction-why-should-i-use-devonfw.asciidoc">Features</a></p>
</li>
<li>
<p><a href="/website/pages/docs/getting-started.asciidoc_further-information.html">Technology Stack</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist linklist">
<dl>
<dt class="hdlist1">Explore</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="/website/pages/docs/getting-started.asciidoc.html">Getting started</a></p>
</li>
<li>
<p><a href="/website/pages/docs/devon4j.asciidoc_architecture.html">Architecture</a></p>
</li>
<li>
<p><a href="/website/pages/resources/resources.html">Resources</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist linklist">
<dl>
<dt class="hdlist1">Docs</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="/website/pages/docs/devonfw-ide-introduction.asciidoc.html">User guide</a></p>
</li>
<li>
<p><a href="/website/pages/docs/master-release-notes.asciidoc.html">Releases information</a></p>
</li>
<li>
<p><a href="/website/pages/docs/master.html">Wiki</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="dlist linklist">
<dl>
<dt class="hdlist1">Community</dt>
<dd>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/orgs/devonfw/people">Contributors</a></p>
</li>
<li>
<p><a href="https://github.com/devonfw/devonfw.github.io/blob/develop/README.asciidoc">Website Contribution</a></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
</div>
</div>
<div class="ulist footerFooter">
<ul>
<li>
<p><a href="https://devonfw.com/website/pages/docs/devonfw-ide-support.asciidoc.html#LICENSE.asciidoc">Terms of Use</a></p>
</li>
<li>
<p><a href="https://github.com/devonfw">Support</a></p>
</li>
</ul>
</div>
</div>
    <script type="module">
      import { UtilsModule } from '/website/shared/utils.js';
      import { HeaderModule } from '/website/components/header/header.js';

      let searchData = { index: null, documents: null };
      UtilsModule.loadIndex(searchData);

      $(window).on('load', function() {
        const queryFun = () => {
          HeaderModule.queryFunction(searchData);
        };

        HeaderModule.searchOnClick(queryFun);
      });
    </script>
    <script>
      let bb = document.getElementById('menu-button');
      bb.addEventListener('click', function() {
        document.querySelector('.website-navbar ul').classList.toggle('visible');
        console.log(document.querySelector('.website-navbar ul'))
      })
    </script>
    <script type="module">
      import { EditLinksModule } from '/website/shared/editlinks.js';

      let alwaysVisible = true;
      if(document.location.pathname.endsWith("pages/welcome/welcome.html")) {
        alwaysVisible = false;
      }
      EditLinksModule.addEditLinks(alwaysVisible);
    </script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
      integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>
<div class="footnote"><sub>

Last updated 2020-09-23 11:01:53 UTC
</sub></div>
</div>
</div>
<script>
  if(!document.location.pathname.endsWith("pages/welcome/welcome.html")) {
    anchors.options.visible = 'always';
  }
  anchors.add();
</script>
</body>
</html>